<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HgCdTe Zincblende Structure (Three.js)</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #f0f0f0; }
        canvas { display: block; }
        #info {
            position: absolute; top: 10px; left: 10px; color: #000;
            background-color: rgba(255, 255, 255, 0.7); padding: 10px;
            border-radius: 5px; font-family: Arial, sans-serif; font-size: 14px;
        }
        #info h2 { margin-top: 0; margin-bottom: 10px; font-size: 16px; }
        #info p { margin: 5px 0; }
        #info ul { margin: 5px 0 5px 20px; padding: 0; }
        #info li { margin-bottom: 3px; }
    </style>
</head>
<body>
    <!-- Load Three.js Core (from cdnjs is fine) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r133/three.min.js"></script>

    <!-- Load OrbitControls from JSDelivr (reliable path for examples) -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.133.0/examples/js/controls/OrbitControls.js"></script>

    <script>
        // Check if libraries loaded correctly
        if (typeof THREE === 'undefined') {
            document.body.innerHTML = '<div style="color: red; padding: 20px;">Error: Three.js failed to load. Check script URL and network connection.</div>';
            throw new Error("Three.js failed to load");
        }
        // *** This check should now pass ***
        if (typeof THREE.OrbitControls === 'undefined') {
            document.body.innerHTML = '<div style="color: red; padding: 20px;">Error: OrbitControls failed to load. Check script URL (using JSDelivr now) and network connection.</div>';
            throw new Error("OrbitControls failed to load"); // Line 45 where the error was reported
        }

        // --- Three.js Scene Setup ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xf0f0f0);
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(4, 4, 6);
        camera.lookAt(0, 0, 0);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.1;
        controls.minDistance = 1;
        controls.maxDistance = 50;
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(5, 10, 7.5);
        scene.add(directionalLight);

        // --- Crystal Structure Logic ---
        const hgMaterial = new THREE.MeshStandardMaterial({ color: 0xAAAAAA, metalness: 0.5, roughness: 0.5 });
        const cdMaterial = new THREE.MeshStandardMaterial({ color: 0x4682B4, metalness: 0.5, roughness: 0.5 });
        const teMaterial = new THREE.MeshStandardMaterial({ color: 0xFFD700, metalness: 0.2, roughness: 0.6 });
        const hgRadius = 0.18;
        const cdRadius = 0.16;
        const teRadius = 0.14;
        const sphereDetail = 16;
        const lattice_a = 1.0;
        const hgGeometry = new THREE.SphereGeometry(hgRadius, sphereDetail, sphereDetail);
        const cdGeometry = new THREE.SphereGeometry(cdRadius, sphereDetail, sphereDetail);
        const teGeometry = new THREE.SphereGeometry(teRadius, sphereDetail, sphereDetail);

        function createUnitCell() {
            const unitCellGroup = new THREE.Group();
            const tePositions = [ [0.00, 0.00, 0.00], [0.00, 0.50, 0.50], [0.50, 0.00, 0.50], [0.50, 0.50, 0.00] ];
            const cationPositions = [ [0.25, 0.25, 0.25], [0.25, 0.75, 0.75], [0.75, 0.25, 0.75], [0.75, 0.75, 0.25] ];
            tePositions.forEach(pos => {
                const atom = new THREE.Mesh(teGeometry, teMaterial);
                atom.position.set(pos[0] * lattice_a, pos[1] * lattice_a, pos[2] * lattice_a);
                unitCellGroup.add(atom);
            });
            cationPositions.forEach(pos => {
                let atom;
                if (Math.random() > 0.5) { atom = new THREE.Mesh(hgGeometry, hgMaterial); }
                else { atom = new THREE.Mesh(cdGeometry, cdMaterial); }
                atom.position.set(pos[0] * lattice_a, pos[1] * lattice_a, pos[2] * lattice_a);
                unitCellGroup.add(atom);
            });
            return unitCellGroup;
        }

        function createSupercell(nx, ny, nz) {
            const supercellGroup = new THREE.Group();
            for (let i = 0; i < nx; i++) {
                for (let j = 0; j < ny; j++) {
                    for (let k = 0; k < nz; k++) {
                        const unitCell = createUnitCell();
                        unitCell.position.set(i * lattice_a, j * lattice_a, k * lattice_a);
                        supercellGroup.add(unitCell);
                    }
                }
            }
            const centerOffset = new THREE.Vector3( (nx * lattice_a) / 2 - lattice_a / 2, (ny * lattice_a) / 2 - lattice_a / 2, (nz * lattice_a) / 2 - lattice_a / 2 );
            supercellGroup.children.forEach(child => { child.position.sub(centerOffset); });
            const supercellBoxSize = new THREE.Vector3(nx * lattice_a, ny * lattice_a, nz * lattice_a);
            const supercellBoxGeom = new THREE.BoxGeometry(supercellBoxSize.x, supercellBoxSize.y, supercellBoxSize.z);
            const supercellEdges = new THREE.EdgesGeometry(supercellBoxGeom);
            const supercellLine = new THREE.LineSegments(supercellEdges, new THREE.LineBasicMaterial({ color: 0x000000, linewidth: 2 }));
            supercellGroup.add(supercellLine);
            return supercellGroup;
        }

        const crystal = createSupercell(2, 2, 2);
        scene.add(crystal);

        // --- UI Setup ---
        function addUI() {
            const infoDiv = document.createElement('div');
            infoDiv.id = 'info';
            infoDiv.innerHTML = `
                <h2>HgCdTe Zincblende (2x2x2)</h2>
                <p>Random alloy simulation using Three.js</p>
                <p>Legend:</p>
                <ul>
                    <li><span style="color: ${hgMaterial.color.getStyle()};">■</span> Mercury (Hg)</li>
                    <li><span style="color: ${cdMaterial.color.getStyle()};">■</span> Cadmium (Cd)</li>
                    <li><span style="color: ${teMaterial.color.getStyle()};">■</span> Tellurium (Te)</li>
                </ul>
                <p>Controls: Drag to rotate, Scroll to zoom</p>
            `;
            document.body.appendChild(infoDiv);
        }
        addUI();

        // --- Handle Window Resizing ---
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // --- Animation Loop ---
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

    </script>
</body>
</html>
