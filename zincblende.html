<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>HgCdTe Zincblende Structure Viewer</title>
  <script src="https://3Dmol.org/build/3Dmol-min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      overflow: hidden;
      background-color: #fafafa;
    }
    #container {
      display: flex;
      height: 100vh;
    }
    #viewer {
      flex: 1;
      position: relative;
    }
    #controls {
      width: 270px;
      padding: 20px;
      background-color: white;
      border-left: 1px solid #eaeaea;
      overflow-y: auto;
      box-shadow: -2px 0 10px rgba(0, 0, 0, 0.05);
    }
    .control-group {
      margin-bottom: 20px;
    }
    .control-title {
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
    }
    button {
      padding: 6px 12px;
      margin: 4px;
      cursor: pointer;
      background-color: #f5f5f5;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      transition: all 0.2s;
      font-size: 14px;
    }
    button:hover {
      background-color: #e9e9e9;
    }
    button.active {
      background-color: #e0e0e0;
      border-color: #c0c0c0;
    }
    .slider {
      width: 100%;
      height: 6px;
      -webkit-appearance: none;
      appearance: none;
      background: #e0e0e0;
      outline: none;
      border-radius: 3px;
    }
    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #4a90e2;
      cursor: pointer;
    }
    .info-panel {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background-color: rgba(255, 255, 255, 0.9);
      padding: 15px;
      border-radius: 8px;
      font-size: 14px;
      max-width: 300px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      z-index: 100;
    }
    .info-panel h3 {
      margin-top: 0;
      margin-bottom: 10px;
      color: #333;
    }
    .legend {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    .legend-color {
      width: 15px;
      height: 15px;
      margin-right: 8px;
      border-radius: 50%;
      border: 1px solid rgba(0, 0, 0, 0.1);
    }
    hr {
      border: none;
      border-top: 1px solid #eaeaea;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="viewer">
      <div class="info-panel">
        <h3>HgCdTe Zincblende Structure</h3>
        <div id="lattice-info">Lattice constant: 6.46 Å</div>
        <div id="composition-info">Composition: Hg<sub>0.7</sub>Cd<sub>0.3</sub>Te</div>
        <div>Space group: F-43m (216)</div>
        <hr>
        <div class="legend">
          <div class="legend-color" style="background-color:#E000E0;"></div> <div>Hg (Magenta)</div>
        </div>
        <div class="legend">
          <div class="legend-color" style="background-color:#CCCCCC;"></div> <div>Cd (Light Grey)</div>
        </div>
        <div class="legend">
          <div class="legend-color" style="background-color:#33CC33;"></div> <div>Te (Green)</div>
        </div>
      </div>
    </div>
    <div id="controls">
      <h2>Controls</h2>

      <div class="control-group">
        <div class="control-title">Composition (x in Hg₁₋ₓCdₓTe)</div>
        <input type="range" id="composition" class="slider" min="0" max="1" step="0.1" value="0.3">
        <div id="composition-value">x = 0.3</div>
      </div>

      <div class="control-group">
        <div class="control-title">Visualization</div>
        <button id="btn-stick">Stick</button>
        <button id="btn-ball-stick" class="active">Ball & Stick</button>
        <button id="btn-spacefill">Spacefill</button>
      </div>

      <div class="control-group">
        <div class="control-title">Unit Cell</div>
        <button id="btn-show-cell">Show Unit Cell</button>
        <button id="btn-hide-cell" class="active">Hide Unit Cell</button>
      </div>

      <div class="control-group">
        <div class="control-title">Labels</div>
        <button id="btn-show-labels">Show Labels</button>
        <button id="btn-hide-labels" class="active">Hide Labels</button>
      </div>

      <div class="control-group">
        <div class="control-title">Supercell</div>
        <button id="btn-1x1x1" class="active">1×1×1</button>
        <button id="btn-2x2x2">2×2×2</button>
      </div>

      <div class="control-group">
        <div class="control-title">Animation</div>
        <button id="btn-spin">Spin</button>
        <button id="btn-stop">Stop</button>
      </div>

      <div class="control-group">
        <div class="control-title">Export</div>
        <button id="btn-screenshot">Screenshot</button>
      </div>

      <div class="control-group">
        <div class="control-title">Structure Information</div>
        <p><strong>HgCdTe (Hg₁₋ₓCdₓTe)</strong></p>
        <p>- Ternary semiconductor alloy</p>
        <p>- Zincblende structure (F-43m)</p>
        <p>- Used in infrared detectors</p>
        <p>- Bandgap: 0 to 1.5 eV (tunable)</p>
        <p>- Applications: IR imaging, photonics</p>
      </div>
    </div>
  </div>

  <script>
    $(document).ready(function() {
      // Initialize the viewer
      let element = $("#viewer");
      let config = {
        backgroundColor: "white",
        antialias: true
      };
      let viewer = $3Dmol.createViewer(element, config);

      // Define constants
      const a_HgTe = 6.46; // Å
      const a_CdTe = 6.48; // Å
      // --- Updated Colors ---
      const atomColors = {
        "Hg": "#E000E0", // Magenta
        "Cd": "#CCCCCC", // Light Grey
        "Te": "#33CC33"  // Green
      };
      // --- End Updated Colors ---


      // State variables
      let latticeConstant = a_HgTe; // Will be updated
      let labelsShown = false;
      let cellShown = false;
      let atomLabels = [];
      let cellLines = [];
      let cellLabel = null;
      let currentViewStyle = "ballAndStick";
      let currentSupercell = 1;
      let currentAtoms = []; // Stores the currently generated atom data

      // Function to generate atom data
      function generateAtomData(cdRatio = 0.3, cellSize = 1) {
        let atoms = [];
        const currentLatticeConstant = a_HgTe * (1 - cdRatio) + a_CdTe * cdRatio;
        for (let i = 0; i < cellSize; i++) {
          for (let j = 0; j < cellSize; j++) {
            for (let k = 0; k < cellSize; k++) {
              let cationPositions = [[0,0,0], [0,0.5,0.5], [0.5,0,0.5], [0.5,0.5,0]];
              let anionPositions = [[0.25,0.25,0.25], [0.25,0.75,0.75], [0.75,0.25,0.75], [0.75,0.75,0.25]];
              cationPositions.forEach(pos => {
                let elemType = Math.random() < cdRatio ? "Cd" : "Hg";
                atoms.push({ elem: elemType, x: (pos[0]+i)*currentLatticeConstant, y: (pos[1]+j)*currentLatticeConstant, z: (pos[2]+k)*currentLatticeConstant });
              });
              anionPositions.forEach(pos => {
                atoms.push({ elem: "Te", x: (pos[0]+i)*currentLatticeConstant, y: (pos[1]+j)*currentLatticeConstant, z: (pos[2]+k)*currentLatticeConstant });
              });
            }
          }
        }
        atoms.forEach((atom, index) => atom.serial = index); // Add serial ID
        return atoms;
      }

      // Function to add atom labels
      function addAtomLabels() {
        for (let label of atomLabels) viewer.removeLabel(label);
        atomLabels = [];
        if (!labelsShown || !currentAtoms || currentAtoms.length === 0) return;
        const center = { x: (currentSupercell*latticeConstant)/2, y: (currentSupercell*latticeConstant)/2, z: (currentSupercell*latticeConstant)/2 };
        const baseCellLimit = latticeConstant;
        currentAtoms.forEach(atom => {
          if (atom.x < baseCellLimit && atom.y < baseCellLimit && atom.z < baseCellLimit) {
            let dx = atom.x - center.x, dy = atom.y - center.y, dz = atom.z - center.z;
            let dist = Math.sqrt(dx*dx + dy*dy + dz*dz);
            const offsetFactor = 1.5;
            let labelPos = { x: atom.x, y: atom.y, z: atom.z };
            if (dist > 0.01) {
              labelPos.x += (dx/dist)*offsetFactor; labelPos.y += (dy/dist)*offsetFactor; labelPos.z += (dz/dist)*offsetFactor;
            } else { labelPos.x += offsetFactor; }
            let labelId = viewer.addLabel(atom.elem, { position: labelPos, backgroundColor: "rgba(255,255,255,0.7)", fontColor: "#333333", fontSize: 12, showBackground: true, backgroundOpacity: 0.5 });
            atomLabels.push(labelId);
          }
        });
      }

      // Function to draw unit cell outline
      function drawUnitCellOutline() {
        for (let lineId of cellLines) viewer.removeShape(lineId);
        cellLines = [];
        if (cellLabel) viewer.removeLabel(cellLabel); cellLabel = null;
        if (!cellShown) return;
        const cellLength = latticeConstant * currentSupercell;
        const vertices = [ [0,0,0],[cellLength,0,0],[0,cellLength,0],[cellLength,cellLength,0], [0,0,cellLength],[cellLength,0,cellLength],[0,cellLength,cellLength],[cellLength,cellLength,cellLength] ];
        const edges = [ [0,1],[0,2],[1,3],[2,3],[4,5],[4,6],[5,7],[6,7],[0,4],[1,5],[2,6],[3,7] ];
        edges.forEach(edge => {
          const start = {x:vertices[edge[0]][0], y:vertices[edge[0]][1], z:vertices[edge[0]][2]};
          const end = {x:vertices[edge[1]][0], y:vertices[edge[1]][1], z:vertices[edge[1]][2]};
          let lineId = viewer.addCylinder({ start: start, end: end, radius: 0.05, color: "#555555", dashed: true, dashLength: 0.4, gapLength: 0.2 });
          cellLines.push(lineId);
        });
        if (currentSupercell === 1) {
          cellLabel = viewer.addLabel(a = ${latticeConstant.toFixed(2)} Å, { position:{x:cellLength/2, y:-1.0, z:-1.0}, backgroundColor:"rgba(255,255,255,0.8)", fontColor:"#333333", fontSize:14, showBackground:true, backgroundOpacity:0.8 });
        }
      }

      // *** CORE RENDERING FUNCTION (Uses existing currentAtoms) ***
      function renderCore() {
        viewer.removeAllModels(); viewer.removeAllShapes();
        for (let label of atomLabels) viewer.removeLabel(label); atomLabels = [];
        for (let lineId of cellLines) viewer.removeShape(lineId); cellLines = [];
        if (cellLabel) viewer.removeLabel(cellLabel); cellLabel = null;

        if (!currentAtoms || currentAtoms.length === 0) { viewer.render(); return; }

        let cdRatio = parseFloat($("#composition").val());
        $("#composition-info").html(Composition: Hg<sub>${(1-cdRatio).toFixed(1)}</sub>Cd<sub>${cdRatio.toFixed(1)}</sub>Te);
        $("#lattice-info").text(Lattice constant: ${latticeConstant.toFixed(2)} Å);

        let model = viewer.addModel(); model.addAtoms(currentAtoms);

        let style = {};
        const baseStickRadius = 0.1; const ballScale = 0.35; const stickModeAtomScale = 0.05;
        const colorScheme = { prop: 'elem', map: atomColors }; // Uses updated colors

        switch (currentViewStyle) {
          case "stick":
            style = {
              stick: {
                radius: baseStickRadius,
                colorscheme: colorScheme
                // Removed bonds: 0 - Rely on default
              },
              sphere: {
                scale: stickModeAtomScale, // Keep tiny spheres
                colorscheme: colorScheme
              }
            }; break;
          case "ballAndStick":
            style = {
              stick: {
                radius: baseStickRadius,
                colorscheme: colorScheme
                 // Removed bonds: 0 - Rely on default
              },
              sphere: {
                scale: ballScale,
                colorscheme: colorScheme
              }
            }; break;
          case "spacefill":
            style = { sphere: { colorscheme: colorScheme } }; break;
        }
        viewer.setStyle({}, style); // Apply the style

        if (cellShown) drawUnitCellOutline();
        if (labelsShown) addAtomLabels();

        viewer.zoomTo(); viewer.render();
      }

      // *** Function to Regenerate Atoms AND Render ***
      function regenerateAndRender() {
        let cdRatio = parseFloat($("#composition").val());
        latticeConstant = a_HgTe * (1 - cdRatio) + a_CdTe * cdRatio;
        $("#composition-value").text(x = ${cdRatio.toFixed(1)});
        currentAtoms = generateAtomData(cdRatio, currentSupercell);
        renderCore();
      }

      // *** Function to Update View Options AND Render ***
      function redrawView() {
        renderCore(); // Just re-render with existing atoms
      }

      // Function to update active button styling
      function updateActiveButtons(group, activeButton) {
        let buttons;
        switch(group){case "visualization":buttons="#btn-stick, #btn-ball-stick, #btn-spacefill";break; case "supercell":buttons="#btn-1x1x1, #btn-2x2x2";break; case "labels":buttons="#btn-show-labels, #btn-hide-labels";break; case "cell":buttons="#btn-show-cell, #btn-hide-cell";break; default: return;}
        $(buttons).removeClass("active"); $(activeButton).addClass("active");
      }

      // --- Event listeners ---
      $("#composition").on("input", regenerateAndRender);
      $("#btn-1x1x1").click(function() { if(currentSupercell!==1){currentSupercell=1;updateActiveButtons("supercell",this);regenerateAndRender();}});
      $("#btn-2x2x2").click(function() { if(currentSupercell!==2){currentSupercell=2;updateActiveButtons("supercell",this);regenerateAndRender();}});

      $("#btn-stick").click(function() { if(currentViewStyle!=="stick"){currentViewStyle="stick";updateActiveButtons("visualization",this);redrawView();}});
      $("#btn-ball-stick").click(function() { if(currentViewStyle!=="ballAndStick"){currentViewStyle="ballAndStick";updateActiveButtons("visualization",this);redrawView();}});
      $("#btn-spacefill").click(function() { if(currentViewStyle!=="spacefill"){currentViewStyle="spacefill";updateActiveButtons("visualization",this);redrawView();}});

      $("#btn-show-labels").click(function() { if(!labelsShown){labelsShown=true;updateActiveButtons("labels",this);redrawView();}});
      $("#btn-hide-labels").click(function() { if(labelsShown){labelsShown=false;updateActiveButtons("labels",this);redrawView();}});
      $("#btn-show-cell").click(function() { if(!cellShown){cellShown=true;updateActiveButtons("cell",this);redrawView();}});
      $("#btn-hide-cell").click(function() { if(cellShown){cellShown=false;updateActiveButtons("cell",this);redrawView();}});

      $("#btn-spin").click(function() { viewer.spin(true); });
      $("#btn-stop").click(function() { viewer.spin(false); });
      $("#btn-screenshot").click(function() {
        let imageData=viewer.pngURI(); let link=document.createElement('a');
        link.download='HgCdTe-zincblende.png'; link.href=imageData;
        document.body.appendChild(link); link.click(); document.body.removeChild(link);
      });
      $(window).on('resize', function() { viewer.resize(); });

      // --- Initial Load ---
      updateActiveButtons("visualization", "#btn-ball-stick"); updateActiveButtons("supercell", "#btn-1x1x1");
      updateActiveButtons("labels", "#btn-hide-labels"); updateActiveButtons("cell", "#btn-hide-cell");
      regenerateAndRender(); // Initial generation and render

    }); // End document ready
  </script>
</body>
</html>
