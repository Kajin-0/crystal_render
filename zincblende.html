<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zincblende Structure Visualization</title>
    <script src="https://3Dmol.org/build/3Dmol-min.js"></script>
    <!-- Rest of the CSS remains the same -->
</head>
<body>
    <!-- Container structure remains the same -->

    <script>
        // Initialize viewer with proper configuration
        let viewer = $3Dmol.createViewer(document.getElementById('viewer-container'), {
            backgroundColor: 'black',
            defaultZoom: 0.8,
            orthographic: true
        });

        // Adjusted unit cell parameters for ZnS (zincblende)
        const cellSize = 5.41; // Actual lattice constant for ZnS in Ångströms
        const atomRadius = 0.5;
        const bondRadius = 0.1;
        const bondThreshold = 2.5; // Adjusted for actual Zn-S bond length (~2.35Å)

        // Improved coordinate generation
        function generateZincblende() {
            let atoms = [];
            let bonds = [];
            
            // FCC positions (Zn)
            const fccPositions = [
                [0,0,0], [0,0.5,0.5], [0.5,0,0.5], [0.5,0.5,0],
                [0.5,0.5,0.5], [0.5,0,0], [0,0.5,0], [0,0,0.5]
            ];

            // Tetrahedral positions (S)
            const tetraPositions = [
                [0.25,0.25,0.25], [0.25,0.75,0.75],
                [0.75,0.25,0.75], [0.75,0.75,0.25]
            ];

            // Create Zn atoms
            fccPositions.forEach(pos => {
                atoms.push({
                    x: pos[0] * cellSize,
                    y: pos[1] * cellSize,
                    z: pos[2] * cellSize,
                    elem: 'Zn',
                    color: '#4CAF50'
                });
            });

            // Create S atoms
            tetraPositions.forEach(pos => {
                atoms.push({
                    x: pos[0] * cellSize,
                    y: pos[1] * cellSize,
                    z: pos[2] * cellSize,
                    elem: 'S',
                    color: '#FFC107'
                });
            });

            // Improved bond calculation
            atoms.forEach((atom1, i) => {
                atoms.forEach((atom2, j) => {
                    if(i >= j) return; // Avoid duplicate bonds
                    const dx = atom1.x - atom2.x;
                    const dy = atom1.y - atom2.y;
                    const dz = atom1.z - atom2.z;
                    const dist = Math.sqrt(dx*dx + dy*dy + dz*dz);
                    
                    if (dist < bondThreshold && atom1.elem !== atom2.elem) {
                        bonds.push({
                            start: i,
                            end: j,
                            color: atom1.elem === 'Zn' ? '#4CAF50' : '#FFC107',
                            radius: bondRadius
                        });
                    }
                });
            });

            return { atoms, bonds };
        }

        // Modified unit cell visualization
        function addUnitCell() {
            const linePositions = [
                // Bottom square
                [0,0,0], [cellSize,0,0],
                [cellSize,0,0], [cellSize,cellSize,0],
                [cellSize,cellSize,0], [0,cellSize,0],
                [0,cellSize,0], [0,0,0],
                
                // Top square
                [0,0,cellSize], [cellSize,0,cellSize],
                [cellSize,0,cellSize], [cellSize,cellSize,cellSize],
                [cellSize,cellSize,cellSize], [0,cellSize,cellSize],
                [0,cellSize,cellSize], [0,0,cellSize],
                
                // Vertical connections
                [0,0,0], [0,0,cellSize],
                [cellSize,0,0], [cellSize,0,cellSize],
                [cellSize,cellSize,0], [cellSize,cellSize,cellSize],
                [0,cellSize,0], [0,cellSize,cellSize]
            ];

            for(let i=0; i<linePositions.length; i+=2) {
                viewer.addLine({
                    start: linePositions[i],
                    end: linePositions[i+1],
                    color: 'white',
                    radius: 0.05
                });
            }
        }

        // Initialize structure with error handling
        try {
            const structure = generateZincblende();
            
            // Add atoms as model
            viewer.addModel();
            structure.atoms.forEach(atom => {
                viewer.addAtom({
                    x: atom.x,
                    y: atom.y,
                    z: atom.z,
                    elem: atom.elem,
                    color: atom.color
                });
            });
            
            // Add bonds
            structure.bonds.forEach(bond => {
                viewer.addBond({
                    a1: bond.start,
                    a2: bond.end,
                    radius: bond.radius,
                    color: bond.color
                });
            });

            addUnitCell();
            
            viewer.setStyle({}, {sphere: {radius: atomRadius}});
            viewer.zoomTo();
            viewer.render();
        } catch (error) {
            console.error('Initialization error:', error);
            alert('Failed to initialize structure. Check console for details.');
        }

        // Rest of the control bindings remain the same
    </script>
</body>
</html>
